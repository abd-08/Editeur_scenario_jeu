{"ast":null,"code":"/**\r\n * DevExtreme (ui/collection/ui.collection_widget.edit.js)\r\n * Version: 18.2.13\r\n * Build date: Wed May 27 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _uiCollection_widget = require(\"./ui.collection_widget.base\");\n\nvar _uiCollection_widget2 = _interopRequireDefault(_uiCollection_widget);\n\nvar _ui = require(\"../widget/ui.errors\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _uiCollection_widgetEditStrategy = require(\"./ui.collection_widget.edit.strategy.plain\");\n\nvar _uiCollection_widgetEditStrategy2 = _interopRequireDefault(_uiCollection_widgetEditStrategy);\n\nvar _data = require(\"../../core/utils/data\");\n\nvar _data_source = require(\"../../data/data_source/data_source\");\n\nvar _selection = require(\"../selection/selection\");\n\nvar _selection2 = _interopRequireDefault(_selection);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nfunction _toConsumableArray(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n\n    return arr2;\n  } else {\n    return Array.from(arr);\n  }\n}\n\nvar ITEM_DELETING_DATA_KEY = \"dxItemDeleting\";\nvar NOT_EXISTING_INDEX = -1;\n\nvar indexExists = function (index) {\n  return index !== NOT_EXISTING_INDEX;\n};\n\nvar CollectionWidget = _uiCollection_widget2.default.inherit({\n  _setOptionsByReference: function () {\n    this.callBase();\n    (0, _extend.extend)(this._optionsByReference, {\n      selectedItem: true\n    });\n  },\n  _getDefaultOptions: function () {\n    return (0, _extend.extend)(this.callBase(), {\n      selectionMode: \"none\",\n      selectionRequired: false,\n      selectionByClick: true,\n      selectedItems: [],\n      selectedItemKeys: [],\n      maxFilterLengthInRequest: 1500,\n      keyExpr: null,\n      selectedIndex: NOT_EXISTING_INDEX,\n      selectedItem: null,\n      onSelectionChanged: null,\n      onItemReordered: null,\n      onItemDeleting: null,\n      onItemDeleted: null\n    });\n  },\n  ctor: function (element, options) {\n    this._userOptions = options || {};\n    this.callBase(element, options);\n  },\n  _init: function () {\n    this._initEditStrategy();\n\n    this.callBase();\n\n    this._initKeyGetter();\n\n    this._initSelectionModule();\n\n    if (\"multi\" === this.option(\"selectionMode\")) {\n      this._showDeprecatedSelectionMode();\n    }\n  },\n  _initKeyGetter: function () {\n    this._keyGetter = (0, _data.compileGetter)(this.option(\"keyExpr\"));\n  },\n  _getKeysByItems: function (selectedItems) {\n    return this._editStrategy.getKeysByItems(selectedItems);\n  },\n  _getItemsByKeys: function (selectedItemKeys, selectedItems) {\n    return this._editStrategy.getItemsByKeys(selectedItemKeys, selectedItems);\n  },\n  _getKeyByIndex: function (index) {\n    return this._editStrategy.getKeyByIndex(index);\n  },\n  _getIndexByKey: function (key) {\n    return this._editStrategy.getIndexByKey(key);\n  },\n  _getIndexByItemData: function (itemData) {\n    return this._editStrategy.getIndexByItemData(itemData);\n  },\n  _isKeySpecified: function () {\n    return !!(this._dataSource && this._dataSource.key());\n  },\n  _getCombinedFilter: function () {\n    return this._dataSource && this._dataSource.filter();\n  },\n  key: function () {\n    if (this.option(\"keyExpr\")) {\n      return this.option(\"keyExpr\");\n    }\n\n    return this._dataSource && this._dataSource.key();\n  },\n  keyOf: function (item) {\n    var key = item;\n\n    var store = this._dataSource && this._dataSource.store();\n\n    if (this.option(\"keyExpr\")) {\n      key = this._keyGetter(item);\n    } else {\n      if (store) {\n        key = store.keyOf(item);\n      }\n    }\n\n    return key;\n  },\n  _initSelectionModule: function () {\n    var that = this,\n        itemsGetter = that._editStrategy.itemsGetter;\n    this._selection = new _selection2.default({\n      mode: this.option(\"selectionMode\"),\n      maxFilterLengthInRequest: this.option(\"maxFilterLengthInRequest\"),\n      equalByReference: !this._isKeySpecified(),\n      onSelectionChanged: function (args) {\n        if (args.addedItemKeys.length || args.removedItemKeys.length) {\n          that.option(\"selectedItems\", that._getItemsByKeys(args.selectedItemKeys, args.selectedItems));\n\n          that._updateSelectedItems(args);\n        }\n      },\n      filter: that._getCombinedFilter.bind(that),\n      totalCount: function () {\n        var items = that.option(\"items\");\n        var dataSource = that._dataSource;\n        return dataSource && dataSource.totalCount() >= 0 ? dataSource.totalCount() : items.length;\n      },\n      key: that.key.bind(that),\n      keyOf: that.keyOf.bind(that),\n      load: function (options) {\n        if (that._dataSource) {\n          var loadOptions = that._dataSource.loadOptions();\n\n          options.customQueryParams = loadOptions.customQueryParams;\n          options.userData = that._dataSource._userData;\n        }\n\n        var store = that._dataSource && that._dataSource.store();\n\n        if (store) {\n          return store.load(options).done(function (loadResult) {\n            if (that._disposed) {\n              return;\n            }\n\n            var items = (0, _data_source.normalizeLoadResult)(loadResult).data;\n\n            that._dataSource._applyMapFunction(items);\n          });\n        } else {\n          return new _deferred.Deferred().resolve(this.plainItems());\n        }\n      },\n      dataFields: function () {\n        return that._dataSource && that._dataSource.select();\n      },\n      plainItems: itemsGetter.bind(that._editStrategy)\n    });\n  },\n  _initEditStrategy: function () {\n    var Strategy = _uiCollection_widgetEditStrategy2.default;\n    this._editStrategy = new Strategy(this);\n  },\n  _getSelectedItemIndices: function (keys) {\n    var that = this,\n        indices = [];\n    keys = keys || this._selection.getSelectedItemKeys();\n\n    that._editStrategy.beginCache();\n\n    (0, _iterator.each)(keys, function (_, key) {\n      var selectedIndex = that._getIndexByKey(key);\n\n      if (indexExists(selectedIndex)) {\n        indices.push(selectedIndex);\n      }\n    });\n\n    that._editStrategy.endCache();\n\n    return indices;\n  },\n  _initMarkup: function () {\n    var _this = this;\n\n    this._rendering = true;\n\n    if (!this._dataSource || !this._dataSource.isLoading()) {\n      this._syncSelectionOptions().done(function () {\n        return _this._normalizeSelectedItems();\n      });\n    }\n\n    this.callBase();\n\n    var selectedItemIndices = this._getSelectedItemIndices();\n\n    this._renderSelection(selectedItemIndices, []);\n  },\n  _render: function () {\n    this.callBase();\n    this._rendering = false;\n  },\n  _fireContentReadyAction: function () {\n    this._rendering = false;\n    this._rendered = true;\n    this.callBase.apply(this, arguments);\n  },\n  _syncSelectionOptions: function (byOption) {\n    byOption = byOption || this._chooseSelectOption();\n    var selectedItem = void 0;\n    var selectedIndex = void 0;\n    var selectedItemKeys = void 0;\n    var selectedItems = void 0;\n\n    switch (byOption) {\n      case \"selectedIndex\":\n        selectedItem = this._editStrategy.getItemDataByIndex(this.option(\"selectedIndex\"));\n\n        if ((0, _type.isDefined)(selectedItem)) {\n          this._setOptionSilent(\"selectedItems\", [selectedItem]);\n\n          this._setOptionSilent(\"selectedItem\", selectedItem);\n\n          this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems([selectedItem]));\n        } else {\n          this._setOptionSilent(\"selectedItems\", []);\n\n          this._setOptionSilent(\"selectedItemKeys\", []);\n\n          this._setOptionSilent(\"selectedItem\", null);\n        }\n\n        break;\n\n      case \"selectedItems\":\n        selectedItems = this.option(\"selectedItems\") || [];\n        selectedIndex = this._editStrategy.getIndexByItemData(selectedItems[0]);\n\n        if (this.option(\"selectionRequired\") && !indexExists(selectedIndex)) {\n          return this._syncSelectionOptions(\"selectedIndex\");\n        }\n\n        this._setOptionSilent(\"selectedItem\", selectedItems[0]);\n\n        this._setOptionSilent(\"selectedIndex\", selectedIndex);\n\n        this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems(selectedItems));\n\n        break;\n\n      case \"selectedItem\":\n        selectedItem = this.option(\"selectedItem\");\n        selectedIndex = this._editStrategy.getIndexByItemData(selectedItem);\n\n        if (this.option(\"selectionRequired\") && !indexExists(selectedIndex)) {\n          return this._syncSelectionOptions(\"selectedIndex\");\n        }\n\n        if ((0, _type.isDefined)(selectedItem)) {\n          this._setOptionSilent(\"selectedItems\", [selectedItem]);\n\n          this._setOptionSilent(\"selectedIndex\", selectedIndex);\n\n          this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems([selectedItem]));\n        } else {\n          this._setOptionSilent(\"selectedItems\", []);\n\n          this._setOptionSilent(\"selectedItemKeys\", []);\n\n          this._setOptionSilent(\"selectedIndex\", NOT_EXISTING_INDEX);\n        }\n\n        break;\n\n      case \"selectedItemKeys\":\n        selectedItemKeys = this.option(\"selectedItemKeys\");\n\n        if (this.option(\"selectionRequired\")) {\n          var selectedItemIndex = this._getIndexByKey(selectedItemKeys[0]);\n\n          if (!indexExists(selectedItemIndex)) {\n            return this._syncSelectionOptions(\"selectedIndex\");\n          }\n        }\n\n        return this._selection.setSelection(selectedItemKeys);\n    }\n\n    return new _deferred.Deferred().resolve().promise();\n  },\n  _chooseSelectOption: function () {\n    var optionName = \"selectedIndex\";\n\n    var isOptionDefined = function (optionName) {\n      var optionValue = this.option(optionName),\n          length = (0, _type.isDefined)(optionValue) && optionValue.length;\n      return length || optionName in this._userOptions;\n    }.bind(this);\n\n    if (isOptionDefined(\"selectedItems\")) {\n      optionName = \"selectedItems\";\n    } else {\n      if (isOptionDefined(\"selectedItem\")) {\n        optionName = \"selectedItem\";\n      } else {\n        if (isOptionDefined(\"selectedItemKeys\")) {\n          optionName = \"selectedItemKeys\";\n        }\n      }\n    }\n\n    return optionName;\n  },\n  _compareKeys: function (oldKeys, newKeys) {\n    if (oldKeys.length !== newKeys.length) {\n      return false;\n    }\n\n    for (var i = 0; i < newKeys.length; i++) {\n      if (oldKeys[i] !== newKeys[i]) {\n        return false;\n      }\n    }\n\n    return true;\n  },\n  _normalizeSelectedItems: function () {\n    if (\"none\" === this.option(\"selectionMode\")) {\n      this._setOptionSilent(\"selectedItems\", []);\n\n      this._syncSelectionOptions(\"selectedItems\");\n    } else {\n      if (\"single\" === this.option(\"selectionMode\")) {\n        var newSelection = this.option(\"selectedItems\");\n\n        if (newSelection.length > 1 || !newSelection.length && this.option(\"selectionRequired\") && this.option(\"items\") && this.option(\"items\").length) {\n          var currentSelection = this._selection.getSelectedItems();\n\n          var normalizedSelection = void 0 === newSelection[0] ? currentSelection[0] : newSelection[0];\n\n          if (void 0 === normalizedSelection) {\n            normalizedSelection = this._editStrategy.itemsGetter()[0];\n          }\n\n          if (this.option(\"grouped\") && normalizedSelection && normalizedSelection.items) {\n            normalizedSelection.items = [normalizedSelection.items[0]];\n          }\n\n          this._selection.setSelection(this._getKeysByItems([normalizedSelection]));\n\n          this._setOptionSilent(\"selectedItems\", [normalizedSelection]);\n\n          return this._syncSelectionOptions(\"selectedItems\");\n        } else {\n          this._selection.setSelection(this._getKeysByItems(newSelection));\n        }\n      } else {\n        var newKeys = this._getKeysByItems(this.option(\"selectedItems\"));\n\n        var oldKeys = this._selection.getSelectedItemKeys();\n\n        if (!this._compareKeys(oldKeys, newKeys)) {\n          this._selection.setSelection(newKeys);\n        }\n      }\n    }\n\n    return new _deferred.Deferred().resolve().promise();\n  },\n  _renderSelection: _common.noop,\n  _itemClickHandler: function (e) {\n    this._createAction(function (e) {\n      this._itemSelectHandler(e.event);\n    }.bind(this), {\n      validatingTargetName: \"itemElement\"\n    })({\n      itemElement: (0, _renderer2.default)(e.currentTarget),\n      event: e\n    });\n\n    this.callBase.apply(this, arguments);\n  },\n  _itemSelectHandler: function (e) {\n    if (!this.option(\"selectionByClick\")) {\n      return;\n    }\n\n    var $itemElement = e.currentTarget;\n\n    if (this.isItemSelected($itemElement)) {\n      this.unselectItem(e.currentTarget);\n    } else {\n      this.selectItem(e.currentTarget);\n    }\n  },\n  _selectedItemElement: function (index) {\n    return this._itemElements().eq(index);\n  },\n  _postprocessRenderItem: function (args) {\n    if (\"none\" !== this.option(\"selectionMode\")) {\n      var $itemElement = (0, _renderer2.default)(args.itemElement),\n          normalizedItemIndex = this._editStrategy.getNormalizedIndex($itemElement),\n          isItemSelected = this._isItemSelected(normalizedItemIndex);\n\n      this._processSelectableItem($itemElement, isItemSelected);\n    }\n  },\n  _processSelectableItem: function ($itemElement, isSelected) {\n    $itemElement.toggleClass(this._selectedItemClass(), isSelected);\n\n    this._setAriaSelected($itemElement, String(isSelected));\n  },\n  _updateSelectedItems: function (args) {\n    var that = this,\n        addedItemKeys = args.addedItemKeys,\n        removedItemKeys = args.removedItemKeys;\n\n    if (that._rendered && (addedItemKeys.length || removedItemKeys.length)) {\n      var selectionChangePromise = that._selectionChangePromise;\n\n      if (!that._rendering) {\n        var addedSelection = [];\n        var normalizedIndex = void 0;\n        var removedSelection = [];\n\n        that._editStrategy.beginCache();\n\n        for (var i = 0; i < addedItemKeys.length; i++) {\n          normalizedIndex = that._getIndexByKey(addedItemKeys[i]);\n          addedSelection.push(normalizedIndex);\n\n          that._addSelection(normalizedIndex);\n        }\n\n        for (var _i = 0; _i < removedItemKeys.length; _i++) {\n          normalizedIndex = that._getIndexByKey(removedItemKeys[_i]);\n          removedSelection.push(normalizedIndex);\n\n          that._removeSelection(normalizedIndex);\n        }\n\n        that._editStrategy.endCache();\n\n        that._updateSelection(addedSelection, removedSelection);\n      }\n\n      (0, _deferred.when)(selectionChangePromise).done(function () {\n        that._fireSelectionChangeEvent(args.addedItems, args.removedItems);\n      });\n    }\n  },\n  _fireSelectionChangeEvent: function (addedItems, removedItems) {\n    this._createActionByOption(\"onSelectionChanged\", {\n      excludeValidators: [\"disabled\", \"readOnly\"]\n    })({\n      addedItems: addedItems,\n      removedItems: removedItems\n    });\n  },\n  _updateSelection: function () {\n    this._renderSelection.apply(this, arguments);\n  },\n  _setAriaSelected: function ($target, value) {\n    this.setAria(\"selected\", value, $target);\n  },\n  _removeSelection: function (normalizedIndex) {\n    var $itemElement = this._editStrategy.getItemElement(normalizedIndex);\n\n    if (indexExists(normalizedIndex)) {\n      this._processSelectableItem($itemElement, false);\n\n      _events_engine2.default.triggerHandler($itemElement, \"stateChanged\", false);\n    }\n  },\n  _showDeprecatedSelectionMode: function () {\n    _ui2.default.log(\"W0001\", this.NAME, \"selectionMode: 'multi'\", \"16.1\", \"Use selectionMode: 'multiple' instead\");\n\n    this.option(\"selectionMode\", \"multiple\");\n  },\n  _addSelection: function (normalizedIndex) {\n    var $itemElement = this._editStrategy.getItemElement(normalizedIndex);\n\n    if (indexExists(normalizedIndex)) {\n      this._processSelectableItem($itemElement, true);\n\n      _events_engine2.default.triggerHandler($itemElement, \"stateChanged\", true);\n    }\n  },\n  _isItemSelected: function (index) {\n    var key = this._getKeyByIndex(index);\n\n    return this._selection.isItemSelected(key);\n  },\n  _optionChanged: function (args) {\n    var _this2 = this;\n\n    switch (args.name) {\n      case \"selectionMode\":\n        if (\"multi\" === args.value) {\n          this._showDeprecatedSelectionMode();\n        } else {\n          this._invalidate();\n        }\n\n        break;\n\n      case \"dataSource\":\n        if (!args.value || Array.isArray(args.value) && !args.value.length) {\n          this.option(\"selectedItemKeys\", []);\n        }\n\n        this.callBase(args);\n        break;\n\n      case \"selectedIndex\":\n      case \"selectedItem\":\n      case \"selectedItems\":\n      case \"selectedItemKeys\":\n        this._syncSelectionOptions(args.name).done(function () {\n          return _this2._normalizeSelectedItems();\n        });\n\n        break;\n\n      case \"keyExpr\":\n        this._initKeyGetter();\n\n        break;\n\n      case \"selectionRequired\":\n        this._normalizeSelectedItems();\n\n        break;\n\n      case \"selectionByClick\":\n      case \"onSelectionChanged\":\n      case \"onItemDeleting\":\n      case \"onItemDeleted\":\n      case \"onItemReordered\":\n      case \"maxFilterLengthInRequest\":\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  _clearSelectedItems: function () {\n    this._setOptionSilent(\"selectedItems\", []);\n\n    this._syncSelectionOptions(\"selectedItems\");\n  },\n  _waitDeletingPrepare: function ($itemElement) {\n    if ($itemElement.data(ITEM_DELETING_DATA_KEY)) {\n      return new _deferred.Deferred().resolve().promise();\n    }\n\n    $itemElement.data(ITEM_DELETING_DATA_KEY, true);\n\n    var deferred = new _deferred.Deferred(),\n        deletingActionArgs = {\n      cancel: false\n    },\n        deletePromise = this._itemEventHandler($itemElement, \"onItemDeleting\", deletingActionArgs, {\n      excludeValidators: [\"disabled\", \"readOnly\"]\n    });\n\n    (0, _deferred.when)(deletePromise).always(function (value) {\n      var deletePromiseExists = !deletePromise,\n          deletePromiseResolved = !deletePromiseExists && \"resolved\" === deletePromise.state(),\n          argumentsSpecified = !!arguments.length,\n          shouldDelete = deletePromiseExists || deletePromiseResolved && !argumentsSpecified || deletePromiseResolved && value;\n      (0, _deferred.when)((0, _deferred.fromPromise)(deletingActionArgs.cancel)).always(function () {\n        $itemElement.data(ITEM_DELETING_DATA_KEY, false);\n      }).done(function (cancel) {\n        shouldDelete && !cancel ? deferred.resolve() : deferred.reject();\n      }).fail(deferred.reject);\n    }.bind(this));\n    return deferred.promise();\n  },\n  _deleteItemFromDS: function ($item) {\n    if (!this._dataSource) {\n      return new _deferred.Deferred().resolve().promise();\n    }\n\n    var deferred = new _deferred.Deferred(),\n        disabledState = this.option(\"disabled\"),\n        dataStore = this._dataSource.store();\n\n    this.option(\"disabled\", true);\n\n    if (!dataStore.remove) {\n      throw _ui2.default.Error(\"E1011\");\n    }\n\n    dataStore.remove(dataStore.keyOf(this._getItemData($item))).done(function (key) {\n      if (void 0 !== key) {\n        deferred.resolve();\n      } else {\n        deferred.reject();\n      }\n    }).fail(function () {\n      deferred.reject();\n    });\n    deferred.always(function () {\n      this.option(\"disabled\", disabledState);\n    }.bind(this));\n    return deferred;\n  },\n  _tryRefreshLastPage: function () {\n    var deferred = new _deferred.Deferred();\n\n    if (this._isLastPage() || this.option(\"grouped\")) {\n      deferred.resolve();\n    } else {\n      this._refreshLastPage().done(function () {\n        deferred.resolve();\n      });\n    }\n\n    return deferred.promise();\n  },\n  _refreshLastPage: function () {\n    this._expectLastItemLoading();\n\n    return this._dataSource.load();\n  },\n  _updateSelectionAfterDelete: function (index) {\n    var key = this._getKeyByIndex(index);\n\n    this._selection.deselect([key]);\n  },\n  _updateIndicesAfterIndex: function (index) {\n    var itemElements = this._itemElements();\n\n    for (var i = index + 1; i < itemElements.length; i++) {\n      (0, _renderer2.default)(itemElements[i]).data(this._itemIndexKey(), i - 1);\n    }\n  },\n  _simulateOptionChange: function (optionName) {\n    var optionValue = this.option(optionName);\n\n    if (optionValue instanceof _data_source.DataSource) {\n      return;\n    }\n\n    this._optionChangedAction({\n      name: optionName,\n      fullName: optionName,\n      value: optionValue\n    });\n  },\n  isItemSelected: function (itemElement) {\n    return this._isItemSelected(this._editStrategy.getNormalizedIndex(itemElement));\n  },\n  selectItem: function (itemElement) {\n    if (\"none\" === this.option(\"selectionMode\")) {\n      return;\n    }\n\n    var itemIndex = this._editStrategy.getNormalizedIndex(itemElement);\n\n    if (!indexExists(itemIndex)) {\n      return;\n    }\n\n    var key = this._getKeyByIndex(itemIndex);\n\n    if (this._selection.isItemSelected(key)) {\n      return;\n    }\n\n    if (\"single\" === this.option(\"selectionMode\")) {\n      this._selection.setSelection([key]);\n    } else {\n      var selectedItemKeys = this.option(\"selectedItemKeys\") || [];\n\n      this._selection.setSelection([].concat(_toConsumableArray(selectedItemKeys), [key]));\n    }\n  },\n  unselectItem: function (itemElement) {\n    var itemIndex = this._editStrategy.getNormalizedIndex(itemElement);\n\n    if (!indexExists(itemIndex)) {\n      return;\n    }\n\n    var selectedItemKeys = this._selection.getSelectedItemKeys();\n\n    if (this.option(\"selectionRequired\") && selectedItemKeys.length <= 1) {\n      return;\n    }\n\n    var key = this._getKeyByIndex(itemIndex);\n\n    if (!this._selection.isItemSelected(key)) {\n      return;\n    }\n\n    this._selection.deselect([key]);\n  },\n  _deleteItemElementByIndex: function (index) {\n    this._updateSelectionAfterDelete(index);\n\n    this._updateIndicesAfterIndex(index);\n\n    this._editStrategy.deleteItemAtIndex(index);\n  },\n  _afterItemElementDeleted: function ($item, deletedActionArgs) {\n    var changingOption = this._dataSource ? \"dataSource\" : \"items\";\n\n    this._simulateOptionChange(changingOption);\n\n    this._itemEventHandler($item, \"onItemDeleted\", deletedActionArgs, {\n      beforeExecute: function () {\n        $item.remove();\n      },\n      excludeValidators: [\"disabled\", \"readOnly\"]\n    });\n\n    this._renderEmptyMessage();\n  },\n  deleteItem: function (itemElement) {\n    var that = this,\n        deferred = new _deferred.Deferred(),\n        $item = this._editStrategy.getItemElement(itemElement),\n        index = this._editStrategy.getNormalizedIndex(itemElement),\n        itemResponseWaitClass = this._itemResponseWaitClass();\n\n    if (indexExists(index)) {\n      this._waitDeletingPrepare($item).done(function () {\n        $item.addClass(itemResponseWaitClass);\n\n        var deletedActionArgs = that._extendActionArgs($item);\n\n        that._deleteItemFromDS($item).done(function () {\n          that._deleteItemElementByIndex(index);\n\n          that._afterItemElementDeleted($item, deletedActionArgs);\n\n          that._tryRefreshLastPage().done(function () {\n            deferred.resolveWith(that);\n          });\n        }).fail(function () {\n          $item.removeClass(itemResponseWaitClass);\n          deferred.rejectWith(that);\n        });\n      }).fail(function () {\n        deferred.rejectWith(that);\n      });\n    } else {\n      deferred.rejectWith(that);\n    }\n\n    return deferred.promise();\n  },\n  reorderItem: function (itemElement, toItemElement) {\n    var deferred = new _deferred.Deferred(),\n        that = this,\n        strategy = this._editStrategy,\n        $movingItem = strategy.getItemElement(itemElement),\n        $destinationItem = strategy.getItemElement(toItemElement),\n        movingIndex = strategy.getNormalizedIndex(itemElement),\n        destinationIndex = strategy.getNormalizedIndex(toItemElement),\n        changingOption = this._dataSource ? \"dataSource\" : \"items\";\n    var canMoveItems = indexExists(movingIndex) && indexExists(destinationIndex) && movingIndex !== destinationIndex;\n\n    if (canMoveItems) {\n      deferred.resolveWith(this);\n    } else {\n      deferred.rejectWith(this);\n    }\n\n    return deferred.promise().done(function () {\n      $destinationItem[strategy.itemPlacementFunc(movingIndex, destinationIndex)]($movingItem);\n      strategy.moveItemAtIndexToIndex(movingIndex, destinationIndex);\n\n      this._updateIndicesAfterIndex(movingIndex);\n\n      that.option(\"selectedItems\", that._getItemsByKeys(that._selection.getSelectedItemKeys(), that._selection.getSelectedItems()));\n\n      if (\"items\" === changingOption) {\n        that._simulateOptionChange(changingOption);\n      }\n\n      that._itemEventHandler($movingItem, \"onItemReordered\", {\n        fromIndex: strategy.getIndex(movingIndex),\n        toIndex: strategy.getIndex(destinationIndex)\n      }, {\n        excludeValidators: [\"disabled\", \"readOnly\"]\n      });\n    });\n  }\n});\n\nmodule.exports = CollectionWidget;","map":{"version":3,"sources":["C:/Users/abdel/PhpstormProjects/editeur_scenario_jeu/node_modules/devextreme/ui/collection/ui.collection_widget.edit.js"],"names":["_renderer","require","_renderer2","_interopRequireDefault","_events_engine","_events_engine2","_uiCollection_widget","_uiCollection_widget2","_ui","_ui2","_extend","_iterator","_common","_type","_uiCollection_widgetEditStrategy","_uiCollection_widgetEditStrategy2","_data","_data_source","_selection","_selection2","_deferred","obj","__esModule","_toConsumableArray","arr","Array","isArray","i","arr2","length","from","ITEM_DELETING_DATA_KEY","NOT_EXISTING_INDEX","indexExists","index","CollectionWidget","default","inherit","_setOptionsByReference","callBase","extend","_optionsByReference","selectedItem","_getDefaultOptions","selectionMode","selectionRequired","selectionByClick","selectedItems","selectedItemKeys","maxFilterLengthInRequest","keyExpr","selectedIndex","onSelectionChanged","onItemReordered","onItemDeleting","onItemDeleted","ctor","element","options","_userOptions","_init","_initEditStrategy","_initKeyGetter","_initSelectionModule","option","_showDeprecatedSelectionMode","_keyGetter","compileGetter","_getKeysByItems","_editStrategy","getKeysByItems","_getItemsByKeys","getItemsByKeys","_getKeyByIndex","getKeyByIndex","_getIndexByKey","key","getIndexByKey","_getIndexByItemData","itemData","getIndexByItemData","_isKeySpecified","_dataSource","_getCombinedFilter","filter","keyOf","item","store","that","itemsGetter","mode","equalByReference","args","addedItemKeys","removedItemKeys","_updateSelectedItems","bind","totalCount","items","dataSource","load","loadOptions","customQueryParams","userData","_userData","done","loadResult","_disposed","normalizeLoadResult","data","_applyMapFunction","Deferred","resolve","plainItems","dataFields","select","Strategy","_getSelectedItemIndices","keys","indices","getSelectedItemKeys","beginCache","each","_","push","endCache","_initMarkup","_this","_rendering","isLoading","_syncSelectionOptions","_normalizeSelectedItems","selectedItemIndices","_renderSelection","_render","_fireContentReadyAction","_rendered","apply","arguments","byOption","_chooseSelectOption","getItemDataByIndex","isDefined","_setOptionSilent","selectedItemIndex","setSelection","promise","optionName","isOptionDefined","optionValue","_compareKeys","oldKeys","newKeys","newSelection","currentSelection","getSelectedItems","normalizedSelection","noop","_itemClickHandler","e","_createAction","_itemSelectHandler","event","validatingTargetName","itemElement","currentTarget","$itemElement","isItemSelected","unselectItem","selectItem","_selectedItemElement","_itemElements","eq","_postprocessRenderItem","normalizedItemIndex","getNormalizedIndex","_isItemSelected","_processSelectableItem","isSelected","toggleClass","_selectedItemClass","_setAriaSelected","String","selectionChangePromise","_selectionChangePromise","addedSelection","normalizedIndex","removedSelection","_addSelection","_i","_removeSelection","_updateSelection","when","_fireSelectionChangeEvent","addedItems","removedItems","_createActionByOption","excludeValidators","$target","value","setAria","getItemElement","triggerHandler","log","NAME","_optionChanged","_this2","name","_invalidate","_clearSelectedItems","_waitDeletingPrepare","deferred","deletingActionArgs","cancel","deletePromise","_itemEventHandler","always","deletePromiseExists","deletePromiseResolved","state","argumentsSpecified","shouldDelete","fromPromise","reject","fail","_deleteItemFromDS","$item","disabledState","dataStore","remove","Error","_getItemData","_tryRefreshLastPage","_isLastPage","_refreshLastPage","_expectLastItemLoading","_updateSelectionAfterDelete","deselect","_updateIndicesAfterIndex","itemElements","_itemIndexKey","_simulateOptionChange","DataSource","_optionChangedAction","fullName","itemIndex","concat","_deleteItemElementByIndex","deleteItemAtIndex","_afterItemElementDeleted","deletedActionArgs","changingOption","beforeExecute","_renderEmptyMessage","deleteItem","itemResponseWaitClass","_itemResponseWaitClass","addClass","_extendActionArgs","resolveWith","removeClass","rejectWith","reorderItem","toItemElement","strategy","$movingItem","$destinationItem","movingIndex","destinationIndex","canMoveItems","itemPlacementFunc","moveItemAtIndexToIndex","fromIndex","getIndex","toIndex","module","exports"],"mappings":"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","sourcesContent":["/**\r\n * DevExtreme (ui/collection/ui.collection_widget.edit.js)\r\n * Version: 18.2.13\r\n * Build date: Wed May 27 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\n\"use strict\";\r\nvar _renderer = require(\"../../core/renderer\");\r\nvar _renderer2 = _interopRequireDefault(_renderer);\r\nvar _events_engine = require(\"../../events/core/events_engine\");\r\nvar _events_engine2 = _interopRequireDefault(_events_engine);\r\nvar _uiCollection_widget = require(\"./ui.collection_widget.base\");\r\nvar _uiCollection_widget2 = _interopRequireDefault(_uiCollection_widget);\r\nvar _ui = require(\"../widget/ui.errors\");\r\nvar _ui2 = _interopRequireDefault(_ui);\r\nvar _extend = require(\"../../core/utils/extend\");\r\nvar _iterator = require(\"../../core/utils/iterator\");\r\nvar _common = require(\"../../core/utils/common\");\r\nvar _type = require(\"../../core/utils/type\");\r\nvar _uiCollection_widgetEditStrategy = require(\"./ui.collection_widget.edit.strategy.plain\");\r\nvar _uiCollection_widgetEditStrategy2 = _interopRequireDefault(_uiCollection_widgetEditStrategy);\r\nvar _data = require(\"../../core/utils/data\");\r\nvar _data_source = require(\"../../data/data_source/data_source\");\r\nvar _selection = require(\"../selection/selection\");\r\nvar _selection2 = _interopRequireDefault(_selection);\r\nvar _deferred = require(\"../../core/utils/deferred\");\r\n\r\nfunction _interopRequireDefault(obj) {\r\n    return obj && obj.__esModule ? obj : {\r\n        \"default\": obj\r\n    }\r\n}\r\n\r\nfunction _toConsumableArray(arr) {\r\n    if (Array.isArray(arr)) {\r\n        for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {\r\n            arr2[i] = arr[i]\r\n        }\r\n        return arr2\r\n    } else {\r\n        return Array.from(arr)\r\n    }\r\n}\r\nvar ITEM_DELETING_DATA_KEY = \"dxItemDeleting\";\r\nvar NOT_EXISTING_INDEX = -1;\r\nvar indexExists = function(index) {\r\n    return index !== NOT_EXISTING_INDEX\r\n};\r\nvar CollectionWidget = _uiCollection_widget2.default.inherit({\r\n    _setOptionsByReference: function() {\r\n        this.callBase();\r\n        (0, _extend.extend)(this._optionsByReference, {\r\n            selectedItem: true\r\n        })\r\n    },\r\n    _getDefaultOptions: function() {\r\n        return (0, _extend.extend)(this.callBase(), {\r\n            selectionMode: \"none\",\r\n            selectionRequired: false,\r\n            selectionByClick: true,\r\n            selectedItems: [],\r\n            selectedItemKeys: [],\r\n            maxFilterLengthInRequest: 1500,\r\n            keyExpr: null,\r\n            selectedIndex: NOT_EXISTING_INDEX,\r\n            selectedItem: null,\r\n            onSelectionChanged: null,\r\n            onItemReordered: null,\r\n            onItemDeleting: null,\r\n            onItemDeleted: null\r\n        })\r\n    },\r\n    ctor: function(element, options) {\r\n        this._userOptions = options || {};\r\n        this.callBase(element, options)\r\n    },\r\n    _init: function() {\r\n        this._initEditStrategy();\r\n        this.callBase();\r\n        this._initKeyGetter();\r\n        this._initSelectionModule();\r\n        if (\"multi\" === this.option(\"selectionMode\")) {\r\n            this._showDeprecatedSelectionMode()\r\n        }\r\n    },\r\n    _initKeyGetter: function() {\r\n        this._keyGetter = (0, _data.compileGetter)(this.option(\"keyExpr\"))\r\n    },\r\n    _getKeysByItems: function(selectedItems) {\r\n        return this._editStrategy.getKeysByItems(selectedItems)\r\n    },\r\n    _getItemsByKeys: function(selectedItemKeys, selectedItems) {\r\n        return this._editStrategy.getItemsByKeys(selectedItemKeys, selectedItems)\r\n    },\r\n    _getKeyByIndex: function(index) {\r\n        return this._editStrategy.getKeyByIndex(index)\r\n    },\r\n    _getIndexByKey: function(key) {\r\n        return this._editStrategy.getIndexByKey(key)\r\n    },\r\n    _getIndexByItemData: function(itemData) {\r\n        return this._editStrategy.getIndexByItemData(itemData)\r\n    },\r\n    _isKeySpecified: function() {\r\n        return !!(this._dataSource && this._dataSource.key())\r\n    },\r\n    _getCombinedFilter: function() {\r\n        return this._dataSource && this._dataSource.filter()\r\n    },\r\n    key: function() {\r\n        if (this.option(\"keyExpr\")) {\r\n            return this.option(\"keyExpr\")\r\n        }\r\n        return this._dataSource && this._dataSource.key()\r\n    },\r\n    keyOf: function(item) {\r\n        var key = item;\r\n        var store = this._dataSource && this._dataSource.store();\r\n        if (this.option(\"keyExpr\")) {\r\n            key = this._keyGetter(item)\r\n        } else {\r\n            if (store) {\r\n                key = store.keyOf(item)\r\n            }\r\n        }\r\n        return key\r\n    },\r\n    _initSelectionModule: function() {\r\n        var that = this,\r\n            itemsGetter = that._editStrategy.itemsGetter;\r\n        this._selection = new _selection2.default({\r\n            mode: this.option(\"selectionMode\"),\r\n            maxFilterLengthInRequest: this.option(\"maxFilterLengthInRequest\"),\r\n            equalByReference: !this._isKeySpecified(),\r\n            onSelectionChanged: function(args) {\r\n                if (args.addedItemKeys.length || args.removedItemKeys.length) {\r\n                    that.option(\"selectedItems\", that._getItemsByKeys(args.selectedItemKeys, args.selectedItems));\r\n                    that._updateSelectedItems(args)\r\n                }\r\n            },\r\n            filter: that._getCombinedFilter.bind(that),\r\n            totalCount: function() {\r\n                var items = that.option(\"items\");\r\n                var dataSource = that._dataSource;\r\n                return dataSource && dataSource.totalCount() >= 0 ? dataSource.totalCount() : items.length\r\n            },\r\n            key: that.key.bind(that),\r\n            keyOf: that.keyOf.bind(that),\r\n            load: function(options) {\r\n                if (that._dataSource) {\r\n                    var loadOptions = that._dataSource.loadOptions();\r\n                    options.customQueryParams = loadOptions.customQueryParams;\r\n                    options.userData = that._dataSource._userData\r\n                }\r\n                var store = that._dataSource && that._dataSource.store();\r\n                if (store) {\r\n                    return store.load(options).done(function(loadResult) {\r\n                        if (that._disposed) {\r\n                            return\r\n                        }\r\n                        var items = (0, _data_source.normalizeLoadResult)(loadResult).data;\r\n                        that._dataSource._applyMapFunction(items)\r\n                    })\r\n                } else {\r\n                    return (new _deferred.Deferred).resolve(this.plainItems())\r\n                }\r\n            },\r\n            dataFields: function() {\r\n                return that._dataSource && that._dataSource.select()\r\n            },\r\n            plainItems: itemsGetter.bind(that._editStrategy)\r\n        })\r\n    },\r\n    _initEditStrategy: function() {\r\n        var Strategy = _uiCollection_widgetEditStrategy2.default;\r\n        this._editStrategy = new Strategy(this)\r\n    },\r\n    _getSelectedItemIndices: function(keys) {\r\n        var that = this,\r\n            indices = [];\r\n        keys = keys || this._selection.getSelectedItemKeys();\r\n        that._editStrategy.beginCache();\r\n        (0, _iterator.each)(keys, function(_, key) {\r\n            var selectedIndex = that._getIndexByKey(key);\r\n            if (indexExists(selectedIndex)) {\r\n                indices.push(selectedIndex)\r\n            }\r\n        });\r\n        that._editStrategy.endCache();\r\n        return indices\r\n    },\r\n    _initMarkup: function() {\r\n        var _this = this;\r\n        this._rendering = true;\r\n        if (!this._dataSource || !this._dataSource.isLoading()) {\r\n            this._syncSelectionOptions().done(function() {\r\n                return _this._normalizeSelectedItems()\r\n            })\r\n        }\r\n        this.callBase();\r\n        var selectedItemIndices = this._getSelectedItemIndices();\r\n        this._renderSelection(selectedItemIndices, [])\r\n    },\r\n    _render: function() {\r\n        this.callBase();\r\n        this._rendering = false\r\n    },\r\n    _fireContentReadyAction: function() {\r\n        this._rendering = false;\r\n        this._rendered = true;\r\n        this.callBase.apply(this, arguments)\r\n    },\r\n    _syncSelectionOptions: function(byOption) {\r\n        byOption = byOption || this._chooseSelectOption();\r\n        var selectedItem = void 0;\r\n        var selectedIndex = void 0;\r\n        var selectedItemKeys = void 0;\r\n        var selectedItems = void 0;\r\n        switch (byOption) {\r\n            case \"selectedIndex\":\r\n                selectedItem = this._editStrategy.getItemDataByIndex(this.option(\"selectedIndex\"));\r\n                if ((0, _type.isDefined)(selectedItem)) {\r\n                    this._setOptionSilent(\"selectedItems\", [selectedItem]);\r\n                    this._setOptionSilent(\"selectedItem\", selectedItem);\r\n                    this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems([selectedItem]))\r\n                } else {\r\n                    this._setOptionSilent(\"selectedItems\", []);\r\n                    this._setOptionSilent(\"selectedItemKeys\", []);\r\n                    this._setOptionSilent(\"selectedItem\", null)\r\n                }\r\n                break;\r\n            case \"selectedItems\":\r\n                selectedItems = this.option(\"selectedItems\") || [];\r\n                selectedIndex = this._editStrategy.getIndexByItemData(selectedItems[0]);\r\n                if (this.option(\"selectionRequired\") && !indexExists(selectedIndex)) {\r\n                    return this._syncSelectionOptions(\"selectedIndex\")\r\n                }\r\n                this._setOptionSilent(\"selectedItem\", selectedItems[0]);\r\n                this._setOptionSilent(\"selectedIndex\", selectedIndex);\r\n                this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems(selectedItems));\r\n                break;\r\n            case \"selectedItem\":\r\n                selectedItem = this.option(\"selectedItem\");\r\n                selectedIndex = this._editStrategy.getIndexByItemData(selectedItem);\r\n                if (this.option(\"selectionRequired\") && !indexExists(selectedIndex)) {\r\n                    return this._syncSelectionOptions(\"selectedIndex\")\r\n                }\r\n                if ((0, _type.isDefined)(selectedItem)) {\r\n                    this._setOptionSilent(\"selectedItems\", [selectedItem]);\r\n                    this._setOptionSilent(\"selectedIndex\", selectedIndex);\r\n                    this._setOptionSilent(\"selectedItemKeys\", this._editStrategy.getKeysByItems([selectedItem]))\r\n                } else {\r\n                    this._setOptionSilent(\"selectedItems\", []);\r\n                    this._setOptionSilent(\"selectedItemKeys\", []);\r\n                    this._setOptionSilent(\"selectedIndex\", NOT_EXISTING_INDEX)\r\n                }\r\n                break;\r\n            case \"selectedItemKeys\":\r\n                selectedItemKeys = this.option(\"selectedItemKeys\");\r\n                if (this.option(\"selectionRequired\")) {\r\n                    var selectedItemIndex = this._getIndexByKey(selectedItemKeys[0]);\r\n                    if (!indexExists(selectedItemIndex)) {\r\n                        return this._syncSelectionOptions(\"selectedIndex\")\r\n                    }\r\n                }\r\n                return this._selection.setSelection(selectedItemKeys)\r\n        }\r\n        return (new _deferred.Deferred).resolve().promise()\r\n    },\r\n    _chooseSelectOption: function() {\r\n        var optionName = \"selectedIndex\";\r\n        var isOptionDefined = function(optionName) {\r\n            var optionValue = this.option(optionName),\r\n                length = (0, _type.isDefined)(optionValue) && optionValue.length;\r\n            return length || optionName in this._userOptions\r\n        }.bind(this);\r\n        if (isOptionDefined(\"selectedItems\")) {\r\n            optionName = \"selectedItems\"\r\n        } else {\r\n            if (isOptionDefined(\"selectedItem\")) {\r\n                optionName = \"selectedItem\"\r\n            } else {\r\n                if (isOptionDefined(\"selectedItemKeys\")) {\r\n                    optionName = \"selectedItemKeys\"\r\n                }\r\n            }\r\n        }\r\n        return optionName\r\n    },\r\n    _compareKeys: function(oldKeys, newKeys) {\r\n        if (oldKeys.length !== newKeys.length) {\r\n            return false\r\n        }\r\n        for (var i = 0; i < newKeys.length; i++) {\r\n            if (oldKeys[i] !== newKeys[i]) {\r\n                return false\r\n            }\r\n        }\r\n        return true\r\n    },\r\n    _normalizeSelectedItems: function() {\r\n        if (\"none\" === this.option(\"selectionMode\")) {\r\n            this._setOptionSilent(\"selectedItems\", []);\r\n            this._syncSelectionOptions(\"selectedItems\")\r\n        } else {\r\n            if (\"single\" === this.option(\"selectionMode\")) {\r\n                var newSelection = this.option(\"selectedItems\");\r\n                if (newSelection.length > 1 || !newSelection.length && this.option(\"selectionRequired\") && this.option(\"items\") && this.option(\"items\").length) {\r\n                    var currentSelection = this._selection.getSelectedItems();\r\n                    var normalizedSelection = void 0 === newSelection[0] ? currentSelection[0] : newSelection[0];\r\n                    if (void 0 === normalizedSelection) {\r\n                        normalizedSelection = this._editStrategy.itemsGetter()[0]\r\n                    }\r\n                    if (this.option(\"grouped\") && normalizedSelection && normalizedSelection.items) {\r\n                        normalizedSelection.items = [normalizedSelection.items[0]]\r\n                    }\r\n                    this._selection.setSelection(this._getKeysByItems([normalizedSelection]));\r\n                    this._setOptionSilent(\"selectedItems\", [normalizedSelection]);\r\n                    return this._syncSelectionOptions(\"selectedItems\")\r\n                } else {\r\n                    this._selection.setSelection(this._getKeysByItems(newSelection))\r\n                }\r\n            } else {\r\n                var newKeys = this._getKeysByItems(this.option(\"selectedItems\"));\r\n                var oldKeys = this._selection.getSelectedItemKeys();\r\n                if (!this._compareKeys(oldKeys, newKeys)) {\r\n                    this._selection.setSelection(newKeys)\r\n                }\r\n            }\r\n        }\r\n        return (new _deferred.Deferred).resolve().promise()\r\n    },\r\n    _renderSelection: _common.noop,\r\n    _itemClickHandler: function(e) {\r\n        this._createAction(function(e) {\r\n            this._itemSelectHandler(e.event)\r\n        }.bind(this), {\r\n            validatingTargetName: \"itemElement\"\r\n        })({\r\n            itemElement: (0, _renderer2.default)(e.currentTarget),\r\n            event: e\r\n        });\r\n        this.callBase.apply(this, arguments)\r\n    },\r\n    _itemSelectHandler: function(e) {\r\n        if (!this.option(\"selectionByClick\")) {\r\n            return\r\n        }\r\n        var $itemElement = e.currentTarget;\r\n        if (this.isItemSelected($itemElement)) {\r\n            this.unselectItem(e.currentTarget)\r\n        } else {\r\n            this.selectItem(e.currentTarget)\r\n        }\r\n    },\r\n    _selectedItemElement: function(index) {\r\n        return this._itemElements().eq(index)\r\n    },\r\n    _postprocessRenderItem: function(args) {\r\n        if (\"none\" !== this.option(\"selectionMode\")) {\r\n            var $itemElement = (0, _renderer2.default)(args.itemElement),\r\n                normalizedItemIndex = this._editStrategy.getNormalizedIndex($itemElement),\r\n                isItemSelected = this._isItemSelected(normalizedItemIndex);\r\n            this._processSelectableItem($itemElement, isItemSelected)\r\n        }\r\n    },\r\n    _processSelectableItem: function($itemElement, isSelected) {\r\n        $itemElement.toggleClass(this._selectedItemClass(), isSelected);\r\n        this._setAriaSelected($itemElement, String(isSelected))\r\n    },\r\n    _updateSelectedItems: function(args) {\r\n        var that = this,\r\n            addedItemKeys = args.addedItemKeys,\r\n            removedItemKeys = args.removedItemKeys;\r\n        if (that._rendered && (addedItemKeys.length || removedItemKeys.length)) {\r\n            var selectionChangePromise = that._selectionChangePromise;\r\n            if (!that._rendering) {\r\n                var addedSelection = [];\r\n                var normalizedIndex = void 0;\r\n                var removedSelection = [];\r\n                that._editStrategy.beginCache();\r\n                for (var i = 0; i < addedItemKeys.length; i++) {\r\n                    normalizedIndex = that._getIndexByKey(addedItemKeys[i]);\r\n                    addedSelection.push(normalizedIndex);\r\n                    that._addSelection(normalizedIndex)\r\n                }\r\n                for (var _i = 0; _i < removedItemKeys.length; _i++) {\r\n                    normalizedIndex = that._getIndexByKey(removedItemKeys[_i]);\r\n                    removedSelection.push(normalizedIndex);\r\n                    that._removeSelection(normalizedIndex)\r\n                }\r\n                that._editStrategy.endCache();\r\n                that._updateSelection(addedSelection, removedSelection)\r\n            }(0, _deferred.when)(selectionChangePromise).done(function() {\r\n                that._fireSelectionChangeEvent(args.addedItems, args.removedItems)\r\n            })\r\n        }\r\n    },\r\n    _fireSelectionChangeEvent: function(addedItems, removedItems) {\r\n        this._createActionByOption(\"onSelectionChanged\", {\r\n            excludeValidators: [\"disabled\", \"readOnly\"]\r\n        })({\r\n            addedItems: addedItems,\r\n            removedItems: removedItems\r\n        })\r\n    },\r\n    _updateSelection: function() {\r\n        this._renderSelection.apply(this, arguments)\r\n    },\r\n    _setAriaSelected: function($target, value) {\r\n        this.setAria(\"selected\", value, $target)\r\n    },\r\n    _removeSelection: function(normalizedIndex) {\r\n        var $itemElement = this._editStrategy.getItemElement(normalizedIndex);\r\n        if (indexExists(normalizedIndex)) {\r\n            this._processSelectableItem($itemElement, false);\r\n            _events_engine2.default.triggerHandler($itemElement, \"stateChanged\", false)\r\n        }\r\n    },\r\n    _showDeprecatedSelectionMode: function() {\r\n        _ui2.default.log(\"W0001\", this.NAME, \"selectionMode: 'multi'\", \"16.1\", \"Use selectionMode: 'multiple' instead\");\r\n        this.option(\"selectionMode\", \"multiple\")\r\n    },\r\n    _addSelection: function(normalizedIndex) {\r\n        var $itemElement = this._editStrategy.getItemElement(normalizedIndex);\r\n        if (indexExists(normalizedIndex)) {\r\n            this._processSelectableItem($itemElement, true);\r\n            _events_engine2.default.triggerHandler($itemElement, \"stateChanged\", true)\r\n        }\r\n    },\r\n    _isItemSelected: function(index) {\r\n        var key = this._getKeyByIndex(index);\r\n        return this._selection.isItemSelected(key)\r\n    },\r\n    _optionChanged: function(args) {\r\n        var _this2 = this;\r\n        switch (args.name) {\r\n            case \"selectionMode\":\r\n                if (\"multi\" === args.value) {\r\n                    this._showDeprecatedSelectionMode()\r\n                } else {\r\n                    this._invalidate()\r\n                }\r\n                break;\r\n            case \"dataSource\":\r\n                if (!args.value || Array.isArray(args.value) && !args.value.length) {\r\n                    this.option(\"selectedItemKeys\", [])\r\n                }\r\n                this.callBase(args);\r\n                break;\r\n            case \"selectedIndex\":\r\n            case \"selectedItem\":\r\n            case \"selectedItems\":\r\n            case \"selectedItemKeys\":\r\n                this._syncSelectionOptions(args.name).done(function() {\r\n                    return _this2._normalizeSelectedItems()\r\n                });\r\n                break;\r\n            case \"keyExpr\":\r\n                this._initKeyGetter();\r\n                break;\r\n            case \"selectionRequired\":\r\n                this._normalizeSelectedItems();\r\n                break;\r\n            case \"selectionByClick\":\r\n            case \"onSelectionChanged\":\r\n            case \"onItemDeleting\":\r\n            case \"onItemDeleted\":\r\n            case \"onItemReordered\":\r\n            case \"maxFilterLengthInRequest\":\r\n                break;\r\n            default:\r\n                this.callBase(args)\r\n        }\r\n    },\r\n    _clearSelectedItems: function() {\r\n        this._setOptionSilent(\"selectedItems\", []);\r\n        this._syncSelectionOptions(\"selectedItems\")\r\n    },\r\n    _waitDeletingPrepare: function($itemElement) {\r\n        if ($itemElement.data(ITEM_DELETING_DATA_KEY)) {\r\n            return (new _deferred.Deferred).resolve().promise()\r\n        }\r\n        $itemElement.data(ITEM_DELETING_DATA_KEY, true);\r\n        var deferred = new _deferred.Deferred,\r\n            deletingActionArgs = {\r\n                cancel: false\r\n            },\r\n            deletePromise = this._itemEventHandler($itemElement, \"onItemDeleting\", deletingActionArgs, {\r\n                excludeValidators: [\"disabled\", \"readOnly\"]\r\n            });\r\n        (0, _deferred.when)(deletePromise).always(function(value) {\r\n            var deletePromiseExists = !deletePromise,\r\n                deletePromiseResolved = !deletePromiseExists && \"resolved\" === deletePromise.state(),\r\n                argumentsSpecified = !!arguments.length,\r\n                shouldDelete = deletePromiseExists || deletePromiseResolved && !argumentsSpecified || deletePromiseResolved && value;\r\n            (0, _deferred.when)((0, _deferred.fromPromise)(deletingActionArgs.cancel)).always(function() {\r\n                $itemElement.data(ITEM_DELETING_DATA_KEY, false)\r\n            }).done(function(cancel) {\r\n                shouldDelete && !cancel ? deferred.resolve() : deferred.reject()\r\n            }).fail(deferred.reject)\r\n        }.bind(this));\r\n        return deferred.promise()\r\n    },\r\n    _deleteItemFromDS: function($item) {\r\n        if (!this._dataSource) {\r\n            return (new _deferred.Deferred).resolve().promise()\r\n        }\r\n        var deferred = new _deferred.Deferred,\r\n            disabledState = this.option(\"disabled\"),\r\n            dataStore = this._dataSource.store();\r\n        this.option(\"disabled\", true);\r\n        if (!dataStore.remove) {\r\n            throw _ui2.default.Error(\"E1011\")\r\n        }\r\n        dataStore.remove(dataStore.keyOf(this._getItemData($item))).done(function(key) {\r\n            if (void 0 !== key) {\r\n                deferred.resolve()\r\n            } else {\r\n                deferred.reject()\r\n            }\r\n        }).fail(function() {\r\n            deferred.reject()\r\n        });\r\n        deferred.always(function() {\r\n            this.option(\"disabled\", disabledState)\r\n        }.bind(this));\r\n        return deferred\r\n    },\r\n    _tryRefreshLastPage: function() {\r\n        var deferred = new _deferred.Deferred;\r\n        if (this._isLastPage() || this.option(\"grouped\")) {\r\n            deferred.resolve()\r\n        } else {\r\n            this._refreshLastPage().done(function() {\r\n                deferred.resolve()\r\n            })\r\n        }\r\n        return deferred.promise()\r\n    },\r\n    _refreshLastPage: function() {\r\n        this._expectLastItemLoading();\r\n        return this._dataSource.load()\r\n    },\r\n    _updateSelectionAfterDelete: function(index) {\r\n        var key = this._getKeyByIndex(index);\r\n        this._selection.deselect([key])\r\n    },\r\n    _updateIndicesAfterIndex: function(index) {\r\n        var itemElements = this._itemElements();\r\n        for (var i = index + 1; i < itemElements.length; i++) {\r\n            (0, _renderer2.default)(itemElements[i]).data(this._itemIndexKey(), i - 1)\r\n        }\r\n    },\r\n    _simulateOptionChange: function(optionName) {\r\n        var optionValue = this.option(optionName);\r\n        if (optionValue instanceof _data_source.DataSource) {\r\n            return\r\n        }\r\n        this._optionChangedAction({\r\n            name: optionName,\r\n            fullName: optionName,\r\n            value: optionValue\r\n        })\r\n    },\r\n    isItemSelected: function(itemElement) {\r\n        return this._isItemSelected(this._editStrategy.getNormalizedIndex(itemElement))\r\n    },\r\n    selectItem: function(itemElement) {\r\n        if (\"none\" === this.option(\"selectionMode\")) {\r\n            return\r\n        }\r\n        var itemIndex = this._editStrategy.getNormalizedIndex(itemElement);\r\n        if (!indexExists(itemIndex)) {\r\n            return\r\n        }\r\n        var key = this._getKeyByIndex(itemIndex);\r\n        if (this._selection.isItemSelected(key)) {\r\n            return\r\n        }\r\n        if (\"single\" === this.option(\"selectionMode\")) {\r\n            this._selection.setSelection([key])\r\n        } else {\r\n            var selectedItemKeys = this.option(\"selectedItemKeys\") || [];\r\n            this._selection.setSelection([].concat(_toConsumableArray(selectedItemKeys), [key]))\r\n        }\r\n    },\r\n    unselectItem: function(itemElement) {\r\n        var itemIndex = this._editStrategy.getNormalizedIndex(itemElement);\r\n        if (!indexExists(itemIndex)) {\r\n            return\r\n        }\r\n        var selectedItemKeys = this._selection.getSelectedItemKeys();\r\n        if (this.option(\"selectionRequired\") && selectedItemKeys.length <= 1) {\r\n            return\r\n        }\r\n        var key = this._getKeyByIndex(itemIndex);\r\n        if (!this._selection.isItemSelected(key)) {\r\n            return\r\n        }\r\n        this._selection.deselect([key])\r\n    },\r\n    _deleteItemElementByIndex: function(index) {\r\n        this._updateSelectionAfterDelete(index);\r\n        this._updateIndicesAfterIndex(index);\r\n        this._editStrategy.deleteItemAtIndex(index)\r\n    },\r\n    _afterItemElementDeleted: function($item, deletedActionArgs) {\r\n        var changingOption = this._dataSource ? \"dataSource\" : \"items\";\r\n        this._simulateOptionChange(changingOption);\r\n        this._itemEventHandler($item, \"onItemDeleted\", deletedActionArgs, {\r\n            beforeExecute: function() {\r\n                $item.remove()\r\n            },\r\n            excludeValidators: [\"disabled\", \"readOnly\"]\r\n        });\r\n        this._renderEmptyMessage()\r\n    },\r\n    deleteItem: function(itemElement) {\r\n        var that = this,\r\n            deferred = new _deferred.Deferred,\r\n            $item = this._editStrategy.getItemElement(itemElement),\r\n            index = this._editStrategy.getNormalizedIndex(itemElement),\r\n            itemResponseWaitClass = this._itemResponseWaitClass();\r\n        if (indexExists(index)) {\r\n            this._waitDeletingPrepare($item).done(function() {\r\n                $item.addClass(itemResponseWaitClass);\r\n                var deletedActionArgs = that._extendActionArgs($item);\r\n                that._deleteItemFromDS($item).done(function() {\r\n                    that._deleteItemElementByIndex(index);\r\n                    that._afterItemElementDeleted($item, deletedActionArgs);\r\n                    that._tryRefreshLastPage().done(function() {\r\n                        deferred.resolveWith(that)\r\n                    })\r\n                }).fail(function() {\r\n                    $item.removeClass(itemResponseWaitClass);\r\n                    deferred.rejectWith(that)\r\n                })\r\n            }).fail(function() {\r\n                deferred.rejectWith(that)\r\n            })\r\n        } else {\r\n            deferred.rejectWith(that)\r\n        }\r\n        return deferred.promise()\r\n    },\r\n    reorderItem: function(itemElement, toItemElement) {\r\n        var deferred = new _deferred.Deferred,\r\n            that = this,\r\n            strategy = this._editStrategy,\r\n            $movingItem = strategy.getItemElement(itemElement),\r\n            $destinationItem = strategy.getItemElement(toItemElement),\r\n            movingIndex = strategy.getNormalizedIndex(itemElement),\r\n            destinationIndex = strategy.getNormalizedIndex(toItemElement),\r\n            changingOption = this._dataSource ? \"dataSource\" : \"items\";\r\n        var canMoveItems = indexExists(movingIndex) && indexExists(destinationIndex) && movingIndex !== destinationIndex;\r\n        if (canMoveItems) {\r\n            deferred.resolveWith(this)\r\n        } else {\r\n            deferred.rejectWith(this)\r\n        }\r\n        return deferred.promise().done(function() {\r\n            $destinationItem[strategy.itemPlacementFunc(movingIndex, destinationIndex)]($movingItem);\r\n            strategy.moveItemAtIndexToIndex(movingIndex, destinationIndex);\r\n            this._updateIndicesAfterIndex(movingIndex);\r\n            that.option(\"selectedItems\", that._getItemsByKeys(that._selection.getSelectedItemKeys(), that._selection.getSelectedItems()));\r\n            if (\"items\" === changingOption) {\r\n                that._simulateOptionChange(changingOption)\r\n            }\r\n            that._itemEventHandler($movingItem, \"onItemReordered\", {\r\n                fromIndex: strategy.getIndex(movingIndex),\r\n                toIndex: strategy.getIndex(destinationIndex)\r\n            }, {\r\n                excludeValidators: [\"disabled\", \"readOnly\"]\r\n            })\r\n        })\r\n    }\r\n});\r\nmodule.exports = CollectionWidget;\r\n"]},"metadata":{},"sourceType":"script"}