{"ast":null,"code":"/**\r\n * DevExtreme (ui/text_box/ui.text_editor.mask.js)\r\n * Version: 18.2.8\r\n * Build date: Tue Apr 23 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar $ = require(\"../../core/renderer\"),\n    caret = require(\"./utils.caret\"),\n    domUtils = require(\"../../core/utils/dom\"),\n    each = require(\"../../core/utils/iterator\").each,\n    eventUtils = require(\"../../events/utils\"),\n    eventsEngine = require(\"../../events/core/events_engine\"),\n    extend = require(\"../../core/utils/extend\").extend,\n    focused = require(\"../widget/selectors\").focused,\n    inArray = require(\"../../core/utils/array\").inArray,\n    isDefined = require(\"../../core/utils/type\").isDefined,\n    messageLocalization = require(\"../../localization/message\"),\n    noop = require(\"../../core/utils/common\").noop,\n    stringUtils = require(\"../../core/utils/string\"),\n    wheelEvent = require(\"../../events/core/wheel\"),\n    MaskRules = require(\"./ui.text_editor.mask.rule\"),\n    TextEditorBase = require(\"./ui.text_editor.base\");\n\nvar stubCaret = function stubCaret() {\n  return {};\n};\n\nvar EMPTY_CHAR = \" \";\nvar ESCAPED_CHAR = \"\\\\\";\nvar TEXTEDITOR_MASKED_CLASS = \"dx-texteditor-masked\";\nvar MASK_EVENT_NAMESPACE = \"dxMask\";\nvar FORWARD_DIRECTION = \"forward\";\nvar BACKWARD_DIRECTION = \"backward\";\nvar BLUR_EVENT = \"blur beforedeactivate\";\nvar BACKSPACE_INPUT_TYPE = \"deleteContentBackward\";\nvar buildInMaskRules = {\n  0: /[0-9]/,\n  9: /[0-9\\s]/,\n  \"#\": /[-+0-9\\s]/,\n  L: function L(char) {\n    return isLiteralChar(char);\n  },\n  l: function l(char) {\n    return isLiteralChar(char) || isSpaceChar(char);\n  },\n  C: /\\S/,\n  c: /./,\n  A: function A(char) {\n    return isLiteralChar(char) || isNumericChar(char);\n  },\n  a: function a(char) {\n    return isLiteralChar(char) || isNumericChar(char) || isSpaceChar(char);\n  }\n};\n\nvar isNumericChar = function isNumericChar(char) {\n  return /[0-9]/.test(char);\n};\n\nvar isLiteralChar = function isLiteralChar(char) {\n  var code = char.charCodeAt();\n  return 64 < code && code < 91 || 96 < code && code < 123 || code > 127;\n};\n\nvar isSpaceChar = function isSpaceChar(char) {\n  return \" \" === char;\n};\n\nvar TextEditorMask = TextEditorBase.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      mask: \"\",\n      maskChar: \"_\",\n      maskRules: {},\n      maskInvalidMessage: messageLocalization.format(\"validation-mask\"),\n      useMaskedValue: false,\n      showMaskMode: \"always\"\n    });\n  },\n  _supportedKeys: function _supportedKeys() {\n    var that = this;\n    var keyHandlerMap = {\n      backspace: that._maskBackspaceHandler,\n      del: that._maskDelHandler,\n      enter: that._changeHandler\n    };\n    var result = that.callBase();\n    each(keyHandlerMap, function (key, callback) {\n      var parentHandler = result[key];\n\n      result[key] = function (e) {\n        that.option(\"mask\") && callback.call(that, e);\n        parentHandler && parentHandler(e);\n      };\n    });\n    return result;\n  },\n  _getSubmitElement: function _getSubmitElement() {\n    return !this.option(\"mask\") ? this.callBase() : this._$hiddenElement;\n  },\n  _initMarkup: function _initMarkup() {\n    this._renderHiddenElement();\n\n    this.callBase();\n  },\n  _attachMouseWheelEventHandlers: function _attachMouseWheelEventHandlers() {\n    var hasMouseWheelHandler = this._onMouseWheel !== noop;\n\n    if (!hasMouseWheelHandler) {\n      return;\n    }\n\n    var input = this._input();\n\n    var eventName = eventUtils.addNamespace(wheelEvent.name, this.NAME);\n\n    var mouseWheelAction = this._createAction(function (e) {\n      if (focused(input)) {\n        var dxEvent = e.event;\n\n        this._onMouseWheel(dxEvent);\n\n        dxEvent.preventDefault();\n        dxEvent.stopPropagation();\n      }\n    }.bind(this));\n\n    eventsEngine.off(input, eventName);\n    eventsEngine.on(input, eventName, function (e) {\n      mouseWheelAction({\n        event: e\n      });\n    });\n  },\n  _onMouseWheel: noop,\n  _render: function _render() {\n    this.callBase();\n\n    this._renderMask();\n\n    this._attachMouseWheelEventHandlers();\n  },\n  _renderHiddenElement: function _renderHiddenElement() {\n    if (this.option(\"mask\")) {\n      this._$hiddenElement = $(\"<input>\").attr(\"type\", \"hidden\").appendTo(this._inputWrapper());\n    }\n  },\n  _removeHiddenElement: function _removeHiddenElement() {\n    this._$hiddenElement && this._$hiddenElement.remove();\n  },\n  _renderMask: function _renderMask() {\n    this.$element().removeClass(TEXTEDITOR_MASKED_CLASS);\n    this._maskRulesChain = null;\n\n    this._detachMaskEventHandlers();\n\n    if (!this.option(\"mask\")) {\n      return;\n    }\n\n    this.$element().addClass(TEXTEDITOR_MASKED_CLASS);\n\n    this._attachMaskEventHandlers();\n\n    this._parseMask();\n\n    this._renderMaskedValue();\n\n    this._changedValue = this._input().val();\n  },\n  _attachMaskEventHandlers: function _attachMaskEventHandlers() {\n    var $input = this._input();\n\n    eventsEngine.on($input, eventUtils.addNamespace(\"focusin\", MASK_EVENT_NAMESPACE), this._maskFocusHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"focusout\", MASK_EVENT_NAMESPACE), this._maskBlurHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"keydown\", MASK_EVENT_NAMESPACE), this._maskKeyDownHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"keypress\", MASK_EVENT_NAMESPACE), this._maskKeyPressHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"input\", MASK_EVENT_NAMESPACE), this._maskInputHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"paste\", MASK_EVENT_NAMESPACE), this._maskPasteHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"cut\", MASK_EVENT_NAMESPACE), this._maskCutHandler.bind(this));\n    eventsEngine.on($input, eventUtils.addNamespace(\"drop\", MASK_EVENT_NAMESPACE), this._maskDragHandler.bind(this));\n\n    this._attachChangeEventHandlers();\n  },\n  _detachMaskEventHandlers: function _detachMaskEventHandlers() {\n    eventsEngine.off(this._input(), \".\" + MASK_EVENT_NAMESPACE);\n  },\n  _attachChangeEventHandlers: function _attachChangeEventHandlers() {\n    if (inArray(\"change\", this.option(\"valueChangeEvent\").split(\" \")) === -1) {\n      return;\n    }\n\n    eventsEngine.on(this._input(), eventUtils.addNamespace(BLUR_EVENT, MASK_EVENT_NAMESPACE), function (e) {\n      this._suppressCaretChanging(this._changeHandler, [e]);\n\n      this._changeHandler(e);\n    }.bind(this));\n  },\n  _suppressCaretChanging: function _suppressCaretChanging(callback, args) {\n    var originalCaret = caret;\n    caret = stubCaret;\n\n    try {\n      callback.apply(this, args);\n    } finally {\n      caret = originalCaret;\n    }\n  },\n  _changeHandler: function _changeHandler(e) {\n    var $input = this._input(),\n        inputValue = $input.val();\n\n    if (inputValue === this._changedValue) {\n      return;\n    }\n\n    this._changedValue = inputValue;\n    var changeEvent = eventUtils.createEvent(e, {\n      type: \"change\"\n    });\n    eventsEngine.trigger($input, changeEvent);\n  },\n  _parseMask: function _parseMask() {\n    this._maskRules = extend({}, buildInMaskRules, this.option(\"maskRules\"));\n    this._maskRulesChain = this._parseMaskRule(0);\n  },\n  _parseMaskRule: function _parseMaskRule(index) {\n    var mask = this.option(\"mask\");\n\n    if (index >= mask.length) {\n      return new MaskRules.EmptyMaskRule();\n    }\n\n    var currentMaskChar = mask[index];\n    var isEscapedChar = currentMaskChar === ESCAPED_CHAR;\n    var result = isEscapedChar ? new MaskRules.StubMaskRule({\n      maskChar: mask[index + 1]\n    }) : this._getMaskRule(currentMaskChar);\n    result.next(this._parseMaskRule(index + 1 + isEscapedChar));\n    return result;\n  },\n  _getMaskRule: function _getMaskRule(pattern) {\n    var ruleConfig;\n    each(this._maskRules, function (rulePattern, allowedChars) {\n      if (rulePattern === pattern) {\n        ruleConfig = {\n          pattern: rulePattern,\n          allowedChars: allowedChars\n        };\n        return false;\n      }\n    });\n    return isDefined(ruleConfig) ? new MaskRules.MaskRule(extend({\n      maskChar: this.option(\"maskChar\")\n    }, ruleConfig)) : new MaskRules.StubMaskRule({\n      maskChar: pattern\n    });\n  },\n  _renderMaskedValue: function _renderMaskedValue() {\n    if (!this._maskRulesChain) {\n      return;\n    }\n\n    var value = this.option(\"value\") || \"\";\n\n    this._maskRulesChain.clear(this._normalizeChainArguments());\n\n    var chainArgs = {\n      length: value.length\n    };\n    chainArgs[this._isMaskedValueMode() ? \"text\" : \"value\"] = value;\n\n    this._handleChain(chainArgs);\n\n    this._displayMask();\n  },\n  _replaceSelectedText: function _replaceSelectedText(text, selection, char) {\n    if (void 0 === char) {\n      return text;\n    }\n\n    var textBefore = text.slice(0, selection.start),\n        textAfter = text.slice(selection.end),\n        edited = textBefore + char + textAfter;\n    return edited;\n  },\n  _isMaskedValueMode: function _isMaskedValueMode() {\n    return this.option(\"useMaskedValue\");\n  },\n  _displayMask: function _displayMask(caret) {\n    caret = caret || this._caret();\n\n    this._renderValue();\n\n    this._caret(caret);\n  },\n  _isValueEmpty: function _isValueEmpty() {\n    return stringUtils.isEmpty(this._value);\n  },\n  _shouldShowMask: function _shouldShowMask() {\n    var showMaskMode = this.option(\"showMaskMode\");\n\n    if (\"onFocus\" === showMaskMode) {\n      return focused(this._input()) || !this._isValueEmpty();\n    }\n\n    return true;\n  },\n  _showMaskPlaceholder: function _showMaskPlaceholder() {\n    if (this._shouldShowMask()) {\n      var text = this._maskRulesChain.text();\n\n      this.option(\"text\", text);\n\n      if (\"onFocus\" === this.option(\"showMaskMode\")) {\n        this._renderDisplayText(text);\n      }\n    }\n  },\n  _renderValue: function _renderValue() {\n    if (this._maskRulesChain) {\n      var text = this._maskRulesChain.text();\n\n      this._showMaskPlaceholder();\n\n      if (this._$hiddenElement) {\n        var value = this._maskRulesChain.value(),\n            hiddenElementValue = this._isMaskedValueMode() ? text : value;\n\n        this._$hiddenElement.val(!stringUtils.isEmpty(value) ? hiddenElementValue : \"\");\n      }\n    }\n\n    this.callBase();\n  },\n  _valueChangeEventHandler: function _valueChangeEventHandler(e) {\n    if (!this._maskRulesChain) {\n      this.callBase.apply(this, arguments);\n      return;\n    }\n\n    this._saveValueChangeEvent(e);\n\n    this.option(\"value\", this._convertToValue().replace(/\\s+$/, \"\"));\n  },\n  _maskFocusHandler: function _maskFocusHandler() {\n    this._showMaskPlaceholder();\n\n    this._direction(FORWARD_DIRECTION);\n\n    if (!this._isValueEmpty() && this.option(\"isValid\")) {\n      this._adjustCaret();\n    } else {\n      var caret = this._maskRulesChain.first();\n\n      this._caretTimeout = setTimeout(function () {\n        this._caret({\n          start: caret,\n          end: caret\n        });\n      }.bind(this), 0);\n    }\n  },\n  _maskBlurHandler: function _maskBlurHandler() {\n    if (\"onFocus\" === this.option(\"showMaskMode\") && this._isValueEmpty()) {\n      this.option(\"text\", \"\");\n\n      this._renderDisplayText(\"\");\n    }\n  },\n  _maskKeyDownHandler: function _maskKeyDownHandler() {\n    this._keyPressHandled = false;\n  },\n  _maskKeyPressHandler: function _maskKeyPressHandler(e) {\n    if (this._keyPressHandled) {\n      return;\n    }\n\n    this._keyPressHandled = true;\n\n    if (this._isControlKeyFired(e)) {\n      return;\n    }\n\n    this._maskKeyHandler(e, function () {\n      this._handleKey(eventUtils.getChar(e));\n\n      return true;\n    });\n  },\n  _maskInputHandler: function _maskInputHandler(e) {\n    if (this._backspaceInputHandled(e.originalEvent && e.originalEvent.inputType)) {\n      this._handleBackspaceInput(e);\n    }\n\n    if (this._keyPressHandled) {\n      return;\n    }\n\n    this._keyPressHandled = true;\n\n    var inputValue = this._input().val();\n\n    var caret = this._caret();\n\n    if (!caret.end) {\n      return;\n    }\n\n    caret.start = caret.end - 1;\n    var oldValue = inputValue.substring(0, caret.start) + inputValue.substring(caret.end);\n    var char = inputValue[caret.start];\n\n    this._input().val(oldValue);\n\n    this._inputHandlerTimer = setTimeout(function () {\n      this._caret({\n        start: caret.start,\n        end: caret.start\n      });\n\n      this._maskKeyHandler(e, function () {\n        this._handleKey(char);\n\n        return true;\n      });\n    }.bind(this));\n  },\n  _backspaceInputHandled: function _backspaceInputHandled(inputType) {\n    return inputType === BACKSPACE_INPUT_TYPE && !this._keyPressHandled;\n  },\n  _handleBackspaceInput: function _handleBackspaceInput(e) {\n    var caret = this._caret();\n\n    this._caret({\n      start: caret.start + 1,\n      end: caret.end + 1\n    });\n\n    this._maskBackspaceHandler(e);\n  },\n  _isControlKeyFired: function _isControlKeyFired(e) {\n    return this._isControlKey(eventUtils.normalizeKeyName(e)) || e.ctrlKey || e.metaKey;\n  },\n  _maskBackspaceHandler: function _maskBackspaceHandler(e) {\n    var that = this;\n    that._keyPressHandled = true;\n\n    var afterBackspaceHandler = function afterBackspaceHandler(needAdjustCaret, callBack) {\n      if (needAdjustCaret) {\n        that._direction(FORWARD_DIRECTION);\n\n        that._adjustCaret();\n      }\n\n      var currentCaret = that._caret();\n\n      clearTimeout(that._backspaceHandlerTimeout);\n      that._backspaceHandlerTimeout = setTimeout(function () {\n        callBack(currentCaret);\n      });\n    };\n\n    that._maskKeyHandler(e, function () {\n      if (that._hasSelection()) {\n        afterBackspaceHandler(true, function (currentCaret) {\n          that._displayMask(currentCaret);\n\n          that._maskRulesChain.reset();\n        });\n        return;\n      }\n\n      if (that._tryMoveCaretBackward()) {\n        afterBackspaceHandler(false, function (currentCaret) {\n          that._caret(currentCaret);\n        });\n        return;\n      }\n\n      that._handleKey(EMPTY_CHAR, BACKWARD_DIRECTION);\n\n      afterBackspaceHandler(true, function (currentCaret) {\n        that._displayMask(currentCaret);\n\n        that._maskRulesChain.reset();\n      });\n    });\n  },\n  _maskDelHandler: function _maskDelHandler(e) {\n    this._keyPressHandled = true;\n\n    this._maskKeyHandler(e, function () {\n      !this._hasSelection() && this._handleKey(EMPTY_CHAR);\n      return true;\n    });\n  },\n  _maskPasteHandler: function _maskPasteHandler(e) {\n    this._keyPressHandled = true;\n\n    var caret = this._caret();\n\n    this._maskKeyHandler(e, function () {\n      var pastingText = domUtils.clipboardText(e);\n\n      var restText = this._maskRulesChain.text().substring(caret.end);\n\n      var accepted = this._handleChain({\n        text: pastingText,\n        start: caret.start,\n        length: pastingText.length\n      });\n\n      var newCaret = caret.start + accepted;\n\n      this._handleChain({\n        text: restText,\n        start: newCaret,\n        length: restText.length\n      });\n\n      this._caret({\n        start: newCaret,\n        end: newCaret\n      });\n\n      return true;\n    });\n  },\n  _handleChain: function _handleChain(args) {\n    var handledCount = this._maskRulesChain.handle(this._normalizeChainArguments(args));\n\n    this._value = this._maskRulesChain.value();\n    this._textValue = this._maskRulesChain.text();\n    return handledCount;\n  },\n  _normalizeChainArguments: function _normalizeChainArguments(args) {\n    args = args || {};\n    args.index = 0;\n    args.fullText = this._maskRulesChain.text();\n    return args;\n  },\n  _maskCutHandler: function _maskCutHandler(e) {\n    var caret = this._caret();\n\n    var selectedText = this._input().val().substring(caret.start, caret.end);\n\n    this._maskKeyHandler(e, function () {\n      domUtils.clipboardText(e, selectedText);\n      return true;\n    });\n  },\n  _maskDragHandler: function _maskDragHandler() {\n    this._clearDragTimer();\n\n    this._dragTimer = setTimeout(function () {\n      this.option(\"value\", this._convertToValue(this._input().val()));\n    }.bind(this));\n  },\n  _convertToValue: function _convertToValue(text) {\n    if (this._isMaskedValueMode()) {\n      text = (text || this._textValue || \"\").replace(new RegExp(this.option(\"maskChar\"), \"g\"), EMPTY_CHAR);\n    } else {\n      text = text || this._value || \"\";\n    }\n\n    return text;\n  },\n  _maskKeyHandler: function _maskKeyHandler(e, tryHandleKeyCallback) {\n    if (this.option(\"readOnly\")) {\n      return;\n    }\n\n    this._direction(FORWARD_DIRECTION);\n\n    e.preventDefault();\n\n    this._handleSelection();\n\n    if (!tryHandleKeyCallback.call(this)) {\n      return;\n    }\n\n    this._direction(FORWARD_DIRECTION);\n\n    this._adjustCaret();\n\n    this._displayMask();\n\n    this._maskRulesChain.reset();\n  },\n  _handleKey: function _handleKey(key, direction) {\n    this._direction(direction || FORWARD_DIRECTION);\n\n    this._adjustCaret(key);\n\n    this._handleKeyChain(key);\n\n    this._moveCaret();\n  },\n  _handleSelection: function _handleSelection() {\n    if (!this._hasSelection()) {\n      return;\n    }\n\n    var caret = this._caret();\n\n    var emptyChars = new Array(caret.end - caret.start + 1).join(EMPTY_CHAR);\n\n    this._handleKeyChain(emptyChars);\n  },\n  _handleKeyChain: function _handleKeyChain(chars) {\n    var caret = this._caret();\n\n    var start = this._isForwardDirection() ? caret.start : caret.start - 1;\n    var end = this._isForwardDirection() ? caret.end : caret.end - 1;\n    var length = start === end ? 1 : end - start;\n\n    this._handleChain({\n      text: chars,\n      start: start,\n      length: length\n    });\n  },\n  _tryMoveCaretBackward: function _tryMoveCaretBackward() {\n    this._direction(BACKWARD_DIRECTION);\n\n    var currentCaret = this._caret().start;\n\n    this._adjustCaret();\n\n    return !currentCaret || currentCaret !== this._caret().start;\n  },\n  _adjustCaret: function _adjustCaret(char) {\n    var caret = this._maskRulesChain.adjustedCaret(this._caret().start, this._isForwardDirection(), char);\n\n    this._caret({\n      start: caret,\n      end: caret\n    });\n  },\n  _moveCaret: function _moveCaret() {\n    var currentCaret = this._caret().start;\n\n    var maskRuleIndex = currentCaret + (this._isForwardDirection() ? 0 : -1);\n    var caret = this._maskRulesChain.isAccepted(maskRuleIndex) ? currentCaret + (this._isForwardDirection() ? 1 : -1) : currentCaret;\n\n    this._caret({\n      start: caret,\n      end: caret\n    });\n  },\n  _caret: function _caret(position) {\n    if (!arguments.length) {\n      return caret(this._input());\n    }\n\n    caret(this._input(), position);\n  },\n  _hasSelection: function _hasSelection() {\n    var caret = this._caret();\n\n    return caret.start !== caret.end;\n  },\n  _direction: function _direction(direction) {\n    if (!arguments.length) {\n      return this._typingDirection;\n    }\n\n    this._typingDirection = direction;\n  },\n  _isForwardDirection: function _isForwardDirection() {\n    return this._direction() === FORWARD_DIRECTION;\n  },\n  _clearDragTimer: function _clearDragTimer() {\n    clearTimeout(this._dragTimer);\n  },\n  _clean: function _clean() {\n    this._clearDragTimer();\n\n    this.callBase();\n  },\n  _validateMask: function _validateMask() {\n    if (!this._maskRulesChain) {\n      return;\n    }\n\n    var isValid = this._maskRulesChain.isValid(this._normalizeChainArguments());\n\n    this.option({\n      isValid: isValid,\n      validationError: isValid ? null : {\n        editorSpecific: true,\n        message: this.option(\"maskInvalidMessage\")\n      }\n    });\n  },\n  _dispose: function _dispose() {\n    clearTimeout(this._inputHandlerTimer);\n    clearTimeout(this._backspaceHandlerTimeout);\n    clearTimeout(this._caretTimeout);\n    this.callBase();\n  },\n  _updateHiddenElement: function _updateHiddenElement() {\n    this._removeHiddenElement();\n\n    if (this.option(\"mask\")) {\n      this._input().removeAttr(\"name\");\n\n      this._renderHiddenElement();\n    }\n\n    this._setSubmitElementName(this.option(\"name\"));\n  },\n  _updateMaskOption: function _updateMaskOption() {\n    this._updateHiddenElement();\n\n    this._renderMask();\n\n    this._validateMask();\n  },\n  _processEmptyMask: function _processEmptyMask(mask) {\n    if (mask) {\n      return;\n    }\n\n    var value = this.option(\"value\");\n    this.option({\n      text: value,\n      isValid: true\n    });\n    this.validationRequest.fire({\n      value: value,\n      editor: this\n    });\n\n    this._renderValue();\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"mask\":\n        this._updateMaskOption();\n\n        this._processEmptyMask(args.value);\n\n        break;\n\n      case \"maskChar\":\n      case \"maskRules\":\n      case \"useMaskedValue\":\n        this._updateMaskOption();\n\n        break;\n\n      case \"value\":\n        this._renderMaskedValue();\n\n        this._validateMask();\n\n        this.callBase(args);\n        break;\n\n      case \"maskInvalidMessage\":\n        break;\n\n      case \"showMaskMode\":\n        this.option(\"text\", \"\");\n\n        this._renderValue();\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  }\n});\nmodule.exports = TextEditorMask;","map":null,"metadata":{},"sourceType":"script"}